<apex:page controller="ResultsController" tabStyle="Results__tab" lightningStylesheets="true" >
    <apex:includeScript value="https://cdn.jsdelivr.net/npm/chart.js@2.8.0" />
    <apex:includeScript value="{!$Resource.jquery}" />
    <script type="text/javascript">
    var selectedWeek = '{!selectedWeek}';
    
    function refreshResults() {
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.ResultsController.getWeeklyResults}', selectedWeek,
            function(results, event) {
                if (event.status) {
                    if (results.pointsAvailable && results.rWrappers && results.rWrappers.length > 0) {
                        $('#wrNotAvailable').hide();
                        drawPointsChart(results, 'Points Scored - Week ' + selectedWeek, 'currentPointsDiv');
                        drawPercentageChart(results, 'Win Percentage - Week ' + selectedWeek, 'currentPercentageDiv');
                    } else {
                        $('#wrNotAvailable').show();
                    }
                } else {
                    flashErrorMessage(event.message);
                }
            },
            {escape: true}
        );
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.ResultsController.getSeasonalResults}',
            function(results, event) {
                if (event.status) {
                    if (results.pointsAvailable && results.rWrappers && results.rWrappers.length > 0) {
                        $('#srNotAvailable').hide();
                        drawPointsChart(results, 'Points Scored - Season', 'seasonPointsDiv');
                        drawPercentageChart(results, 'Win Percentage - Season', 'seasonPercentageDiv');
                    } else {
                        $('#srNotAvailable').show();
                    }
                } else {
                    flashErrorMessage(event.message);
                }
            },
            {escape: true}
        );
        setLastRefreshed();
        setTimeout('refreshResults()', 120000);
    }
    
    function drawPointsChart(results, chartTitle, domId) {
        const pointsData = {
            labels: results.rWrappers.map(result => result.nickname),
            datasets: [{
                label: chartTitle,
                backgroundColor: 'blue',
                data: results.rWrappers.map(result => result.pointsScored),
            }]
        }
        const ctx = document.getElementById(domId);
        const pointsChart = new Chart(ctx, {
            type: 'horizontalBar',
            data: pointsData,
            options: {
                scales: {
                    xAxes: [{
                        display: true,
                        type: 'linear',
                        ticks: {
                            min: 0,
                            max: results.pointsAvailable,
                            precision: 1
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Total points available: ' + results.pointsAvailable.toFixed(1)
                        }
                    }]
                },
                tooltips: {
                    callbacks: {
                        label: (tooltipItem, data) => {
                            return Number(tooltipItem.xLabel).toFixed(1);
                        }
                    }
                },
            }
        });
    }
    
    function drawPercentageChart(results, chartTitle, domId) {
        var percentageData = {
            labels: results.rWrappers.map(result => result.nickname),
            datasets: [{
                label: chartTitle,
                backgroundColor: 'red',
                data: results.rWrappers.map(result => result.winPercentage),
            }]
        }
        var ctx = document.getElementById(domId);
        var pointsChart = new Chart(ctx, {
            type: 'horizontalBar',
            data: percentageData,
            options: {
                scales: {
                    xAxes: [{
                        display: true,
                        type: 'linear',
                        ticks: {
                            min: 0.000,
                            max: 1.000,
                            callback: (value) => value.toFixed(3)
                        }
                    }]
                },
                tooltips: {
                    callbacks: {
                        label: (tooltipItem, data) => {
                            return Number(tooltipItem.xLabel).toFixed(3);
                        }
                    }
                },
            }
        });
    }
    
    function setLastRefreshed() {
        var currentDate = new Date();
        var day = currentDate.getDate();
        var month = currentDate.getMonth() + 1;
        var year = currentDate.getFullYear();
        var hours = currentDate.getHours();
        var minutes = currentDate.getMinutes();
        if (minutes < 10) {
            minutes = '0' + minutes;
        }
        var suffix = 'AM';
        if (hours >= 12) {
            suffix = 'PM';
            hours = hours - 12;
        }
        if (hours == 0) {
            hours = 12;
        }
        $('#lastRefreshed').html('Last refreshed: ' + month + '/' + day + '/' + year + ' ' + hours + ':' + minutes + ' ' + suffix);
    }
    
    function flashErrorMessage(msg) {
        $('#errorMsg').html(msg);
        $('#errorMsg').fadeIn(600, function() {
            setTimeout('$(\'#errorMsg\').fadeOut(600)', 10000);
        });
    }

    $(document).ready(function() {
        $('#errorMsg').hide();
        $('#wrNotAvailable').hide();
        $('#srNotAvailable').hide();
        refreshResults();
    });
    </script>
    
    <h1 id="errorMsg" style="font-size:1.2em; font-weight:bold; color:red;"></h1>
    <p id="lastRefreshed" style="font-size:1.2em; font-weight:bold" ></p>
    <p style="font-size:1.1em;" >
        This page will refresh automatically every two minutes.
        <apex:outputPanel layout="inline" rendered="{!VALUE(currentWeek) > 1}" >
            <apex:outputLabel value="Click here to view results for prior weeks: " />
            <apex:repeat value="{!weeks}" var="weekNumber" >
                <apex:outputLink value="{!$Page.Results}" style="{!IF(weekNumber == selectedWeek, 'font-weight:bold; color:red', 'font-weight:normal;')}" >
                    <apex:outputText value="{!weekNumber}" />
                    <apex:param name="week" value="{!weekNumber}" />
                </apex:outputLink>
            </apex:repeat> 
        </apex:outputPanel>
    </p>
    <table id="resultsTable" >
        <tbody>
            <tr id="wrNotAvailable" >
                <td style="font-size:1.2em; font-weight:bold; color:orange; padding-bottom:20px;" >Weekly results not yet available</td>
            </tr>
            <tr id="wrRow" >
                <td>
                    <canvas id="currentPointsDiv" height="400" width="400"></canvas>
                </td>
                <td>
                    <canvas id="currentPercentageDiv" height="400" width="400"></canvas>
                </td>
            </tr>
            <tr id="srNotAvailable" >
                <td style="font-size:1.2em; font-weight:bold; color:orange;" >Seasonal results not yet available</td>
            </tr>
            <tr id="srRow" >
                <td>
                    <canvas id="seasonPointsDiv" height="400" width="400"></canvas>
                </td>
                <td>
                    <canvas id="seasonPercentageDiv" height="400" width="400"></canvas>
                </td>
            </tr>
        </tbody>
    </table>
</apex:page>