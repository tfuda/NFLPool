<apex:page controller="ResultsController" tabStyle="Results__tab" lightningStylesheets="true" >
    <apex:includeScript value="https://cdn.jsdelivr.net/npm/chart.js@2.8.0" />
    <apex:includeScript value="{!$Resource.jquery}" />
    <script type="text/javascript">
    var selectedWeek = '{!selectedWeek}';
    
    function refreshResults() {
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.ResultsController.getWeeklyResults}', selectedWeek,
            function(results, event) {
                if (event.status) {
                    if (results.pointsAvailable && results.rWrappers && results.rWrappers.length > 0) {
                        $('#WRNotAvailable').hide();
                        drawPointsChart(results, 'Points Scored - Week ' + selectedWeek, 'CurrentPoints');
                        drawPercentageChart(results, 'Win Percentage - Week ' + selectedWeek, 'CurrentPercentage');
                    } else {
                        $('#WRNotAvailable').show();
                    }
                } else {
                    flashErrorMessage(event.message);
                }
            },
            {escape: true}
        );
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.ResultsController.getSeasonalResults}',
            function(results, event) {
                if (event.status) {
                    if (results.pointsAvailable && results.rWrappers && results.rWrappers.length > 0) {
                        $('#SRNotAvailable').hide();
                        drawPointsChart(results, 'Points Scored - Season', 'SeasonPoints');
                        drawPercentageChart(results, 'Win Percentage - Season', 'SeasonPercentage');
                    } else {
                        $('#SRNotAvailable').show();
                    }
                } else {
                    flashErrorMessage(event.message);
                }
            },
            {escape: true}
        );
        setLastRefreshed();
        setTimeout('refreshResults()', 120000);
    }
    
    function drawPointsChart(results, chartTitle, domId) {
        const pointsData = {
            labels: results.rWrappers.map(result => result.nickname),
            datasets: [{
                label: chartTitle,
                backgroundColor: 'blue',
                data: results.rWrappers.map(result => result.pointsScored),
            }]
        }
        const ctx = document.getElementById(domId);
        const pointsChart = new Chart(ctx, {
            type: 'horizontalBar',
            data: pointsData,
            options: {
                responsive: true,
                scales: {
                    xAxes: [{
                        display: true,
                        type: 'linear',
                        ticks: {
                            min: 0,
                            max: results.pointsAvailable,
                            precision: 1
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Total points available: ' + results.pointsAvailable.toFixed(1)
                        }
                    }]
                },
                tooltips: {
                    callbacks: {
                        label: (tooltipItem, data) => {
                            return Number(tooltipItem.xLabel).toFixed(1);
                        }
                    }
                },
                legend: {
                    display: true,
                    labels: {
                        boxWidth: 0,
                    }
                },
            }
        });
    }
    
    function drawPercentageChart(results, chartTitle, domId) {
        var percentageData = {
            labels: results.rWrappers.map(result => result.nickname),
            datasets: [{
                label: chartTitle,
                backgroundColor: 'red',
                data: results.rWrappers.map(result => result.winPercentage),
            }]
        }
        var ctx = document.getElementById(domId);
        var pointsChart = new Chart(ctx, {
            type: 'horizontalBar',
            data: percentageData,
            options: {
                responsive: true,
                scales: {
                    xAxes: [{
                        display: true,
                        type: 'linear',
                        ticks: {
                            min: 0.000,
                            max: 1.000,
                            callback: (value) => value.toFixed(3)
                        }
                    }]
                },
                tooltips: {
                    callbacks: {
                        label: (tooltipItem, data) => {
                            return Number(tooltipItem.xLabel).toFixed(3);
                        }
                    }
                },
                legend: {
                    display: true,
                    labels: {
                        boxWidth: 0,
                    }
                },
                layout: {
                    padding: {
                        top: 20,
                        right: 0,
                        bottom: 0,
                        left: 0
                    }
                }
            }
        });
    }
    
    function setLastRefreshed() {
        var currentDate = new Date();
        var day = currentDate.getDate();
        var month = currentDate.getMonth() + 1;
        var year = currentDate.getFullYear();
        var hours = currentDate.getHours();
        var minutes = currentDate.getMinutes();
        if (minutes < 10) {
            minutes = '0' + minutes;
        }
        var suffix = 'AM';
        if (hours >= 12) {
            suffix = 'PM';
            hours = hours - 12;
        }
        if (hours == 0) {
            hours = 12;
        }
        $('#LastRefreshed').html('Last refreshed: ' + month + '/' + day + '/' + year + ' ' + hours + ':' + minutes + ' ' + suffix);
    }
    
    function flashErrorMessage(msg) {
        $('#ErrorMsg').html(msg);
        $('#ErrorMsg').fadeIn(600, function() {
            setTimeout('$(\'#ErrorMsg\').fadeOut(600)', 10000);
        });
    }

    $(document).ready(function() {
        $('#ErrorMsg').hide();
        $('#WRNotAvailable').hide();
        $('#SRNotAvailable').hide();
        refreshResults();
    });
    </script>

    <style>
    h1 {
        font-size: 1.3em;
    }

    h2 {
        font-size: 1.2em;
    }

    #ErrorMsg {
        font-weight: bold;
        color: red;
    }

    #LastRefreshed {
        font-weight: bold;
    }

    .resultsContainer {
        padding-top: 20px;
    }

    .notAvailableMessage {
        font-weight: bold;
        color: orange;
    }
    </style>

    <h2 id="ErrorMsg"></h2>
    <h2 id="LastRefreshed"></h2>
    <p>
        This page will refresh automatically every two minutes.
        <apex:outputPanel layout="inline" rendered="{!VALUE(currentWeek) > 1}" >
            <apex:outputLabel value="Click here to view results for prior weeks: " />
            <apex:repeat value="{!weeks}" var="weekNumber" >
                <apex:outputLink value="{!$Page.Results}" style="{!IF(weekNumber == selectedWeek, 'font-weight:bold; color:red', 'font-weight:normal;')}" >
                    <apex:outputText value="{!weekNumber}" />
                    <apex:param name="week" value="{!weekNumber}" />
                </apex:outputLink>
            </apex:repeat> 
        </apex:outputPanel>
    </p>
    <div style="width: 60%">
        <div class="resultsContainer">
            <h1>Weekly Results</h1>
            <h2 id="WRNotAvailable">
                Weekly results not yet available
            </h2>
            <canvas id="CurrentPoints"></canvas>
            <canvas id="CurrentPercentage"></canvas>
        </div>
        <div class="resultsContainer">
            <h1>Seasonal Results</h1>
            <h2 id="SRNotAvailable">
                Seasonal results not yet available
            </h2>
            <canvas id="SeasonPoints"></canvas>
            <canvas id="SeasonPercentage"></canvas>
        </div>
    </div>
</apex:page>